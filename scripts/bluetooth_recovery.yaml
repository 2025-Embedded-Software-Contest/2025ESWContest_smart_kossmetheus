bluetooth_adapter_reset:
  alias: "Bluetooth 어댑터 리셋"
  description: "BLE 센서 연결 문제 시 블루투스 어댑터를 리셋합니다."
  icon: mdi:bluetooth
  sequence:
    - service: system_log.write
      data:
        message: "블루투스 어댑터 리셋 시작..."
        level: info
    
    # BLE Monitor 통합 비활성화 시도
    - service: homeassistant.reload_config_entry  
      data:
        entry_id: "{{ states.sensor | selectattr('entity_id', 'match', '.*ble.*') | map(attribute='entity_id') | list | first | default('') }}"
      continue_on_error: true
    
    # 5초 대기
    - delay: "00:00:05"
    
    - service: system_log.write
      data:
        message: "BLE Monitor 통합 재시작 완료. 블루투스 장치 재검색 중..."
        level: info
    
    # 알림 생성
    - service: persistent_notification.create
      data:
        title: "블루투스 어댑터 리셋 완료"
        message: >
          블루투스 어댑터 리셋이 완료되었습니다.
          BLE 센서들이 몇 분 내에 다시 연결될 예정입니다.
          
          만약 문제가 지속되면:
          1. 해당 BLE 장치들을 물리적으로 재부팅하세요
          2. Home Assistant를 재시작하세요
        notification_id: bluetooth_reset_status

thinq_integration_reload:
  alias: "LG ThinQ 통합 재로드"
  description: "LG ThinQ 통합을 재로드하여 김치냉장고 센서를 복구합니다."
  icon: mdi:refrigerator
  sequence:
    - service: system_log.write
      data:
        message: "LG ThinQ 통합 재로드 시작..."
        level: info
    
    # ThinQ 관련 엔티티 확인
    - variables:
        thinq_entities: >
          {{ states.sensor | selectattr('entity_id', 'match', 'sensor.jubang_.*')  
                           | map(attribute='entity_id') | list }}
    
    # 통합 재로드 시도
    - service: homeassistant.reload_config_entry
      target:
        entity_id: "{{ thinq_entities }}"
      continue_on_error: true
    
    # 10초 대기
    - delay: "00:00:10"
    
    - service: system_log.write
      data:
        message: "LG ThinQ 통합 재로드 완료. 센서 상태 확인 중..."
        level: info
    
    # 결과 확인 및 알림
    - service: persistent_notification.create
      data:
        title: "LG ThinQ 통합 재로드 완료"  
        message: >
          LG ThinQ 통합 재로드가 완료되었습니다.
          김치냉장고 온도 센서들이 복구되었는지 확인하세요.
          
          관련 센서들:
          {{ thinq_entities | join('\n') }}
          
          만약 문제가 지속되면:
          1. 설정 > 통합에서 LG ThinQ를 수동으로 재구성하세요
          2. LG 앱에서 계정 로그인 상태를 확인하세요
        notification_id: thinq_reload_status

apple_devices_battery_check:
  alias: "Apple 기기 배터리 센서 점검"
  description: "iCloud3/Mobile App 연결을 점검하고 Apple 기기 배터리 정보를 복구합니다."
  icon: mdi:apple
  sequence:
    - service: system_log.write
      data:
        message: "Apple 기기 배터리 센서 점검 시작..."
        level: info
    
    # Apple 배터리 센서 목록 
    - variables:
        apple_battery_sensors: 
          - sensor.gimuhyeonyi_apple_watch_battery
          - sensor.gimuhyeonyi_macbook_pro_battery  
          - sensor.uhyeonyi_ipad_pro_battery
          - sensor.uhyeonyi_iphone_xs_battery
    
    # 각 센서 상태 확인
    - repeat:
        count: "{{ apple_battery_sensors | length }}"
        sequence:
          - variables:
              current_sensor: "{{ apple_battery_sensors[repeat.index - 1] }}"
              sensor_state: "{{ states(current_sensor) }}"
          
          - service: system_log.write
            data:
              message: "{{ current_sensor }}: {{ sensor_state }}"
              level: info
    
    # iCloud3 통합 재로드 시도
    - service: homeassistant.reload_config_entry
      target:
        entity_id: "{{ apple_battery_sensors }}"
      continue_on_error: true
    
    # 결과 알림
    - service: persistent_notification.create
      data:
        title: "Apple 기기 배터리 센서 점검 완료"
        message: >
          Apple 기기 배터리 센서 점검이 완료되었습니다.
          
          점검된 센서들:
          {% for sensor in apple_battery_sensors %}
          - {{ sensor }}: {{ states(sensor) }}
          {% endfor %}
          
          unavailable 센서가 있다면:
          1. iCloud3 설정에서 iCloud 계정을 재인증하세요
          2. Mobile App(Home Assistant Companion)이 각 기기에 설치되었는지 확인하세요
          3. 각 기기에서 "나의 찾기" 설정을 확인하세요
        notification_id: apple_battery_check_status
