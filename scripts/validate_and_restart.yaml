# =============================================================================
# Home Assistant 설정 검증 및 재시작 스크립트
# 로그 오류 해결 후 시스템 상태 확인 및 재시작
# =============================================================================

validate_and_restart_ha:
  alias: "Home Assistant 설정 검증 및 재시작"
  description: "로그 오류 해결 후 설정을 검증하고 필요시 재시작합니다."
  icon: mdi:restart
  sequence:
    # 1. 설정 검증 시작 알림
    - service: persistent_notification.create
      data:
        title: "🔍 설정 검증 시작"
        message: |
          Home Assistant 설정 검증을 시작합니다.
          주요 수정 사항:
          
          ✅ LG ThinQ 김치냉장고 센서 오류 해결
          ✅ Steam Wishlist API 오류 처리 개선
          ✅ BESTIN/SmartThings deprecated constants 업데이트
          ✅ Device registry via_device 참조 문제 해결
          
          잠시만 기다려주세요...
        notification_id: config_validation_start

    # 2. 설정 검증 실행
    - service: homeassistant.check_config
      continue_on_error: true
      
    # 3. 잠시 대기
    - delay: "00:00:03"
    
    # 4. 통합별 상태 확인
    - service: system_log.write
      data:
        message: "통합 상태 확인 중..."
        level: info
        
    # 5. LG ThinQ 센서 상태 확인
    - variables:
        thinq_sensors: >
          {{ states.sensor | selectattr('entity_id', 'match', 'sensor.*gimci.*') | list }}
        steam_sensor: >
          {{ states.sensor | selectattr('entity_id', 'match', 'sensor.steam.*') | list }}
        bestin_devices: >
          {{ states | selectattr('entity_id', 'match', '.*bestin.*') | list }}

    # 6. 결과 알림
    - service: persistent_notification.create
      data:
        title: "✅ 설정 검증 완료"
        message: |
          설정 검증이 완료되었습니다.
          
          📊 통합 상태:
          - LG ThinQ 센서: {{ thinq_sensors | length }}개 (문제 센서는 숨김 처리됨)
          - Steam Wishlist: {{ steam_sensor | length }}개 (오류 처리 개선됨)
          - BESTIN 장치: {{ bestin_devices | length }}개 (deprecated 상수 업데이트됨)
          
          🔄 재시작을 원하시면 '재시작 확인' 스크립트를 실행하세요.
          
          변경사항:
          • customize.yaml 추가 (센서 속성 수정)
          • Steam Wishlist API 오류 처리 강화
          • BESTIN/SmartThings 호환성 개선
          • Device registry 경고 해결
        notification_id: config_validation_complete

confirm_restart:
  alias: "재시작 확인 및 실행"
  description: "사용자 확인 후 Home Assistant를 재시작합니다."
  icon: mdi:restart-alert
  sequence:
    # 1. 재시작 확인 알림
    - service: persistent_notification.create
      data:
        title: "🔄 재시작 확인"
        message: |
          Home Assistant를 재시작하시겠습니까?
          
          재시작 후 다음 사항이 적용됩니다:
          ✅ 모든 오류 수정 사항 적용
          ✅ 새로운 customize 설정 로드
          ✅ 개선된 통합 설정 적용
          
          재시작하려면 이 알림을 닫고 30초 후 자동으로 재시작됩니다.
          취소하려면 '재시작 취소' 스크립트를 실행하세요.
        notification_id: restart_confirmation

    # 2. 30초 대기 (취소 가능 시간)
    - delay: "00:00:30"
    
    # 3. 재시작 시작 알림
    - service: persistent_notification.create
      data:
        title: "🔄 재시작 중..."
        message: |
          Home Assistant를 재시작합니다.
          잠시 후 다시 연결해주세요.
          
          예상 소요 시간: 2-3분
        notification_id: restarting_now
    
    # 4. 로그 기록
    - service: system_log.write
      data:
        message: "사용자 요청으로 Home Assistant 재시작 중..."
        level: info
    
    # 5. Home Assistant 재시작
    - service: homeassistant.restart

cancel_restart:
  alias: "재시작 취소"
  description: "예정된 재시작을 취소합니다."
  icon: mdi:cancel
  sequence:
    - service: persistent_notification.dismiss
      data:
        notification_id: restart_confirmation
    - service: persistent_notification.create
      data:
        title: "❌ 재시작 취소됨"
        message: |
          Home Assistant 재시작이 취소되었습니다.
          
          변경사항은 저장되었지만 일부 설정은
          재시작 후에 완전히 적용됩니다.
        notification_id: restart_cancelled

# 기존 ThinQ 통합 재로드 스크립트 개선
thinq_integration_reload_enhanced:
  alias: "LG ThinQ 통합 재로드 (개선됨)"
  description: "LG ThinQ 통합을 안전하게 재로드합니다."
  icon: mdi:refrigerator
  sequence:
    - service: system_log.write
      data:
        message: "LG ThinQ 통합 재로드 시작 (문제 센서 처리 개선됨)..."
        level: info
    
    # Custom smartthinq_sensors 통합만 대상으로 재로드
    - variables:
        custom_thinq_entities: >
          {{ states.sensor | selectattr('entity_id', 'match', 'sensor.jubang.*') | list }}
    
    - service: homeassistant.reload_config_entry
      target:
        entity_id: "{{ custom_thinq_entities | map(attribute='entity_id') | list }}"
      continue_on_error: true
    
    - delay: "00:00:10"
    
    - service: persistent_notification.create
      data:
        title: "LG ThinQ 통합 재로드 완료"  
        message: |
          LG ThinQ 통합 재로드가 완료되었습니다.
          
          📊 감지된 센서: {{ custom_thinq_entities | length }}개
          📝 문제 센서들은 customize.yaml에서 처리됨
          
          🔧 문제가 지속되면:
          1. 설정 > 통합에서 SmartThinQ Sensors 재구성
          2. LG 앱에서 계정 로그인 상태 확인
          3. 네트워크 연결 상태 확인
        notification_id: thinq_reload_enhanced
