alias: Enhanced Unavailable Entities Monitoring  
id: enhanced_unavailable_monitoring
description: í–¥ìƒëœ unavailable ì—”í‹°í‹° ëª¨ë‹ˆí„°ë§ ë° ë¶„ë¥˜ ì‹œìŠ¤í…œ
triggers:
  - trigger: homeassistant
    event: start
  - trigger: time_pattern
    minutes: "/10"  # 10ë¶„ë§ˆë‹¤ ì²´í¬ (ë” ìì£¼)
  - trigger: state
    entity_id: sensor.unavailable_entities_count
    # ì—”í‹°í‹° ê°œìˆ˜ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ íŠ¸ë¦¬ê±°
conditions: []
actions:
  - variables:
      # ëª¨ë“  unavailable ì—”í‹°í‹° ìˆ˜ì§‘
      all_unavailable: >-
        {{ states | selectattr('state', 'in', ['unavailable','unknown'])
                   | map(attribute='entity_id') | list }}
      
      # í†µí•©ë³„ë¡œ ë¶„ë¥˜
      classifications:
        thinq_fridge: >-
          {{ all_unavailable | select('match', 'sensor.jubang_gimcinaengjanggo.*temperature') | list }}
        
        thinq_dishwasher: >-
          {{ all_unavailable | select('match', 'sensor.jubang_siggiseceoggi.*') | list }}
        
        apple_batteries: >-
          {{ all_unavailable | select('match', 'sensor..*battery') | list }}
        
        ble_sensors: >-
          {{ all_unavailable | select('match', '.*ble.*') | list }}
        
        xbox_entities: >-
          {{ all_unavailable | select('match', '.*xbox.*') | list }}
        
        network_sensors: >-
          {{ all_unavailable | select('match', 'sensor..*router.*|sensor.fast_com.*') | list }}
        
        other_sensors: >-
          {{ all_unavailable | reject('match', 'sensor.jubang_.*|sensor..*battery|.*ble.*|.*xbox.*|sensor..*router.*|sensor.fast_com.*') | list }}

  # ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸ ì§„ë‹¨
  - action: system_log.write
    data:
      message: >
        ğŸ” Unavailable Entities ë¶„ì„ ê²°ê³¼:
        ğŸ“Š ì´ê³„: {{ all_unavailable | length }}ê°œ
        
        ğŸ“‚ ì¹´í…Œê³ ë¦¬ë³„ ë¶„ì„:
        ğŸ§Š ê¹€ì¹˜ëƒ‰ì¥ê³  ì˜¨ë„: {{ classifications.thinq_fridge | length }}ê°œ
        ğŸ½ï¸ ì‹ê¸°ì„¸ì²™ê¸°: {{ classifications.thinq_dishwasher | length }}ê°œ  
        ğŸ”‹ Apple ë°°í„°ë¦¬: {{ classifications.apple_batteries | length }}ê°œ
        ğŸ“¡ BLE ì„¼ì„œ: {{ classifications.ble_sensors | length }}ê°œ
        ğŸ® Xbox: {{ classifications.xbox_entities | length }}ê°œ
        ğŸŒ ë„¤íŠ¸ì›Œí¬: {{ classifications.network_sensors | length }}ê°œ
        â“ ê¸°íƒ€: {{ classifications.other_sensors | length }}ê°œ
      level: info

  # ê¹€ì¹˜ëƒ‰ì¥ê³  ì˜¨ë„ ì„¼ì„œ íŠ¹ë³„ ì²˜ë¦¬
  - choose:
      - conditions: "{{ classifications.thinq_fridge | length > 0 }}"
        sequence:
          - service: persistent_notification.create
            data:
              title: "âš ï¸ ê¹€ì¹˜ëƒ‰ì¥ê³  ì˜¨ë„ ì„¼ì„œ ë¬¸ì œ"
              message: >
                **ë¬¸ì œ ì„¼ì„œë“¤:**
                {{ classifications.thinq_fridge | join('\n') }}
                
                **ì˜í–¥ë„ ë¶„ì„:**
                - í‰ê·  ì˜¨ë„ ì„¼ì„œ: {{ 'PARTIAL' if classifications.thinq_fridge | length < 4 else 'DOWN' }}
                - ì‚¬ìš© ê°€ëŠ¥í•œ ì„¼ì„œ: {{ states.sensor.kimchi_fridge_avg_temperature.attributes.available_sensors | default('unknown') }}
                
                **ê¶Œì¥ ì¡°ì¹˜:**
                1. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰: `thinq_integration_reload`
                2. LG ThinQ ì•±ì—ì„œ ê¸°ê¸° ìƒíƒœ í™•ì¸
                3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœ ì ê²€
              notification_id: thinq_fridge_alert

  # Apple ë°°í„°ë¦¬ ì„¼ì„œ íŠ¹ë³„ ì²˜ë¦¬
  - choose:
      - conditions: "{{ classifications.apple_batteries | length > 0 }}"
        sequence:
          - service: persistent_notification.create
            data:
              title: "ğŸ Apple ê¸°ê¸° ë°°í„°ë¦¬ ì„¼ì„œ ë¬¸ì œ"
              message: >
                **ë¬¸ì œ ì„¼ì„œë“¤:**
                {{ classifications.apple_batteries | join('\n') }}
                
                **ê¶Œì¥ ì¡°ì¹˜:**
                1. iCloud3 í†µí•© ìƒíƒœ í™•ì¸
                2. ê° ê¸°ê¸°ì—ì„œ Home Assistant Companion ì•± í™•ì¸
                3. "ë‚˜ì˜ ì°¾ê¸°" í™œì„±í™” ì—¬ë¶€ í™•ì¸
                4. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰: `apple_devices_battery_check`
              notification_id: apple_battery_alert

  # BLE ì„¼ì„œ íŠ¹ë³„ ì²˜ë¦¬  
  - choose:
      - conditions: "{{ classifications.ble_sensors | length > 0 }}"
        sequence:
          - service: persistent_notification.create
            data:
              title: "ğŸ“¡ BLE ì„¼ì„œ ì—°ê²° ë¬¸ì œ"
              message: >
                **ë¬¸ì œ ì„¼ì„œë“¤:**
                {{ classifications.ble_sensors | join('\n') }}
                
                **ê¶Œì¥ ì¡°ì¹˜:**
                1. ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰: `bluetooth_adapter_reset`
                2. BLE ì¥ì¹˜ë“¤ ë¬¼ë¦¬ì  ì¬ë¶€íŒ…
                3. ë¸”ë£¨íˆ¬ìŠ¤ ì–´ëŒ‘í„° ì „ì› ê´€ë¦¬ ì„¤ì • í™•ì¸
              notification_id: ble_sensor_alert

  # í†µí•© ìƒíƒœ ìš”ì•½ ë³´ê³ ì„œ ìƒì„±
  - service: persistent_notification.create
    data:
      title: "ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ ìš”ì•½"
      message: >
        **ì „ì²´ ì‹œìŠ¤í…œ ìƒíƒœ** ({{ now().strftime('%Y-%m-%d %H:%M') }})
        
        ğŸŸ¢ **ì •ìƒ ì‘ë™ ì¤‘:**
        - ì‹œìŠ¤í…œ ì„¼ì„œ: {{ states.sensor | selectattr('entity_id', 'match', 'sensor.(processor_use|memory_use_percent|disk_use_percent)') | selectattr('state', 'ne', 'unavailable') | list | length }}/3
        - ì „ë ¥ ì„¼ì„œ: {{ states.sensor | selectattr('entity_id', 'match', '.*power') | selectattr('state', 'ne', 'unavailable') | list | length }}ê°œ
        - ì˜¨ìŠµë„ ì„¼ì„œ: {{ states.sensor | selectattr('entity_id', 'match', '.*temperature|.*humidity') | selectattr('state', 'ne', 'unavailable') | list | length }}ê°œ
        
        ğŸ”´ **ë¬¸ì œ ë°œìƒ:**
        - ì´ unavailable: {{ all_unavailable | length }}ê°œ
        - ì£¼ìš” ë¬¸ì œ: 
        {% if classifications.thinq_fridge | length > 0 %}  ê¹€ì¹˜ëƒ‰ì¥ê³  ({{ classifications.thinq_fridge | length }}) {% endif %}
        {% if classifications.apple_batteries | length > 0 %}  Appleë°°í„°ë¦¬ ({{ classifications.apple_batteries | length }}) {% endif %}
        {% if classifications.ble_sensors | length > 0 %}  BLEì„¼ì„œ ({{ classifications.ble_sensors | length }}) {% endif %}
        
        **ë³µêµ¬ ìŠ¤í¬ë¦½íŠ¸:** ì„¤ì • > ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥
      notification_id: system_status_summary

mode: single
