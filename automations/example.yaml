# ==============================================
# ì „ë ¥ ê´€ë¦¬ ìë™í™”
# ==============================================

# ë†’ì€ ì „ë ¥ ì†Œë¹„ ì•Œë¦¼
- id: high_power_consumption_alert
  alias: "ë†’ì€ ì „ë ¥ ì†Œë¹„ ì•Œë¦¼"
  description: "ì´ ì „ë ¥ ì†Œë¹„ê°€ ì„ê³„ê°’ì„ ì´ˆê³¼í–ˆì„ ë•Œ ì•Œë¦¼"
  trigger:
    - platform: numeric_state
      entity_id: sensor.total_power_consumption
      above: 500  # 500W ì´ìƒ
      for: "00:05:00"  # 5ë¶„ê°„ ì§€ì†
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - service: persistent_notification.create
      data:
        title: "âš¡ ì „ë ¥ ì†Œë¹„ ì£¼ì˜"
        message: >
          í˜„ì¬ ì „ë ¥ ì†Œë¹„ëŸ‰ì´ {{ states('sensor.total_power_consumption') }}Wì…ë‹ˆë‹¤.
          ì—ë„ˆì§€ ì ˆì•½ì„ ìœ„í•´ ë¶ˆí•„ìš”í•œ ê¸°ê¸°ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.
        notification_id: high_power_alert

# ì €ì „ë ¥ ëª¨ë“œ (ë¶€ì¬ì‹œ)
- id: energy_saving_mode
  alias: "ì—ë„ˆì§€ ì ˆì•½ ëª¨ë“œ"
  description: "ì§‘ì— ì•„ë¬´ë„ ì—†ì„ ë•Œ ì—ë„ˆì§€ ì ˆì•½"
  trigger:
    - platform: state
      entity_id: binary_sensor.someone_home
      from: "on"
      to: "off"
      for: "00:30:00"  # 30ë¶„ê°„ ë¶€ì¬
  action:
    - service: light.turn_off
      target:
        entity_id:
          - light.zigbee_dimmer
          - light.smart_bulb
    - service: persistent_notification.create
      data:
        title: "ğŸ  ì—ë„ˆì§€ ì ˆì•½ ëª¨ë“œ í™œì„±í™”"
        message: "ë¶€ì¬ ì¤‘ì´ë¯€ë¡œ ì¡°ëª…ì„ ìë™ìœ¼ë¡œ êº¼ë‘ì—ˆìŠµë‹ˆë‹¤."

# ==============================================
# ê±´ê°• & ë°°í„°ë¦¬ ê´€ë¦¬ ìë™í™”
# ==============================================

# ì €ë°°í„°ë¦¬ ë””ë°”ì´ìŠ¤ ì•Œë¦¼
- id: low_battery_device_alert
  alias: "ì €ë°°í„°ë¦¬ ë””ë°”ì´ìŠ¤ ì•Œë¦¼"
  description: "ë°°í„°ë¦¬ê°€ ë¶€ì¡±í•œ ë””ë°”ì´ìŠ¤ê°€ ìˆì„ ë•Œ ì•Œë¦¼"
  trigger:
    - platform: state
      entity_id: binary_sensor.low_battery_devices
      from: "off"
      to: "on"
  action:
    - service: persistent_notification.create
      data:
        title: "ğŸ”‹ ë°°í„°ë¦¬ ë¶€ì¡± ì£¼ì˜"
        message: >
          ë°°í„°ë¦¬ê°€ ë¶€ì¡±í•œ ë””ë°”ì´ìŠ¤ê°€ ìˆìŠµë‹ˆë‹¤:
          
          {% set devices = [
            ('Apple Watch', states('sensor.gimuhyeonyi_apple_watch_battery')),
            ('MacBook Pro', states('sensor.gimuhyeonyi_macbook_pro_battery')),
            ('iPad Pro', states('sensor.uhyeonyi_ipad_pro_battery')),
            ('iPhone XS', states('sensor.uhyeonyi_iphone_xs_battery'))
          ] %}
          {% for device, battery in devices %}
          {% if battery|int < 20 %}
          - {{ device }}: {{ battery }}%
          {% endif %}
          {% endfor %}
        notification_id: low_battery_alert

# ê°œë³„ ë””ë°”ì´ìŠ¤ ê·¹ì €ë°°í„°ë¦¬ ì•Œë¦¼ (10% ì´í•˜)
- id: critical_battery_alert
  alias: "ê·¹ì €ë°°í„°ë¦¬ ì•Œë¦¼"
  description: "ë°°í„°ë¦¬ê°€ 10% ì´í•˜ì¼ ë•Œ ì¦‰ì‹œ ì•Œë¦¼"
  trigger:
    - platform: numeric_state
      entity_id: 
        - sensor.gimuhyeonyi_apple_watch_battery
        - sensor.gimuhyeonyi_macbook_pro_battery
        - sensor.uhyeonyi_ipad_pro_battery
        - sensor.uhyeonyi_iphone_xs_battery
      below: 10
  action:
    - service: persistent_notification.create
      data:
        title: "ğŸš¨ ë°°í„°ë¦¬ ìœ„í—˜ ìˆ˜ì¤€"
        message: >
          {{ trigger.to_state.attributes.friendly_name }}ì˜ 
          ë°°í„°ë¦¬ê°€ {{ trigger.to_state.state }}%ì…ë‹ˆë‹¤. ì¦‰ì‹œ ì¶©ì „í•˜ì„¸ìš”!
        notification_id: critical_battery_{{ trigger.entity_id.split('.')[1] }}

# ì–‘ì¹˜ ì•Œë¦¼ (ì €ë… ì‹œê°„)
- id: evening_brushing_reminder
  alias: "ì €ë… ì–‘ì¹˜ ì•Œë¦¼"
  description: "ì €ë…ì— ì–‘ì¹˜ë¥¼ í•˜ì§€ ì•Šì•˜ì„ ë•Œ ì•Œë¦¼"
  trigger:
    - platform: time
      at: "22:00:00"  # ì €ë… 10ì‹œ
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
    # ìµœê·¼ 2ì‹œê°„ ë‚´ì— ì–‘ì¹˜í•˜ì§€ ì•Šì•˜ì„ ë•Œ
    - condition: template
      value_template: >
        {{ (now() - states.sensor.smart_series_7000_6f50.last_changed).total_seconds() > 7200 }}
  action:
    - service: persistent_notification.create
      data:
        title: "ğŸª¥ ì–‘ì¹˜ ì•Œë¦¼"
        message: "ìµœê·¼ 2ì‹œê°„ ë™ì•ˆ ì–‘ì¹˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."
        notification_id: brushing_reminder

# ì‹¬ë°•ìˆ˜ ê³¼ë„ ìƒìŠ¹ ê°ì§€
- id: high_heart_rate_alert
  alias: "ì‹¬ë°•ìˆ˜ ê²½ê³ "
  description: "ì‹¬ë°•ìˆ˜ê°€ 120bpm ì´ìƒì¼ ë•Œ ê²½ê³ "
  trigger:
    - platform: numeric_state
      entity_id: sensor.ble_heart_rate_e0e33e6221b5
      above: 120
      for: "00:01:00"
  action:
    - service: persistent_notification.create
      data:
        title: "â¤ï¸ ì‹¬ë°•ìˆ˜ ê²½ê³ "
        message: "ì‹¬ë°•ìˆ˜ê°€ 120bpm ì´ìƒìœ¼ë¡œ ìƒìŠ¹í–ˆìŠµë‹ˆë‹¤. ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”."
        notification_id: heart_rate_alert

# ì¼ì¼ ê±¸ìŒ ìˆ˜ ëª©í‘œ ë‹¬ì„± ì¶•í•˜
- id: daily_steps_goal_achievement
  alias: "ì¼ì¼ ê±¸ìŒìˆ˜ ëª©í‘œ ë‹¬ì„±"
  description: "í•˜ë£¨ ê±¸ìŒìˆ˜ ëª©í‘œë¥¼ ë‹¬ì„±í–ˆì„ ë•Œ ì¶•í•˜ ë©”ì‹œì§€"
  trigger:
    - platform: numeric_state
      entity_id: sensor.ble_steps_e0e33e6221b5
      above: 10000  # ì¼ì¼ ëª©í‘œ: 10,000ë³´
  condition:
    - condition: template
      value_template: >
        {{ (now().date() - states.sensor.ble_steps_e0e33e6221b5.last_changed.date()).days == 0 }}
  action:
    - service: persistent_notification.create
      data:
        title: "ğŸ‰ ê±¸ìŒìˆ˜ ëª©í‘œ ë‹¬ì„±!"
        message: >
          ì¶•í•˜í•©ë‹ˆë‹¤! ì˜¤ëŠ˜ {{ states('sensor.ble_steps_e0e33e6221b5') }}ë³´ë¥¼ ê±¸ìœ¼ì…¨ë„¤ìš”.
          ê±´ê°•í•œ í•˜ë£¨ë¥¼ ë³´ë‚´ê³  ê³„ì‹œëŠ”êµ°ìš”! ğŸ‘
        notification_id: steps_goal_achieved

# ê¹€ì¹˜ëƒ‰ì¥ê³  ì˜¨ë„ ì´ìƒ ì•Œë¦¼
- id: kimchi_fridge_temperature_alert
  alias: "ê¹€ì¹˜ëƒ‰ì¥ê³  ì˜¨ë„ ì´ìƒ"
  description: "ê¹€ì¹˜ëƒ‰ì¥ê³  ì˜¨ë„ê°€ ì ì • ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ì„ ë•Œ ì•Œë¦¼"
  trigger:
    - platform: numeric_state
      entity_id: sensor.kimchi_fridge_avg_temperature
      above: 5    # 5ë„ ì´ìƒ
      for: "00:30:00"  # 30ë¶„ê°„ ì§€ì†
    - platform: numeric_state
      entity_id: sensor.kimchi_fridge_avg_temperature
      below: -5   # -5ë„ ì´í•˜
      for: "00:30:00"  # 30ë¶„ê°„ ì§€ì†
  action:
    - service: persistent_notification.create
      data:
        title: "ğŸ¥¬ ê¹€ì¹˜ëƒ‰ì¥ê³  ì˜¨ë„ ì£¼ì˜"
        message: >
          ê¹€ì¹˜ëƒ‰ì¥ê³  í‰ê·  ì˜¨ë„ê°€ {{ states('sensor.kimchi_fridge_avg_temperature') }}Â°Cì…ë‹ˆë‹¤.
          ì ì • ì˜¨ë„ ë²”ìœ„(-5Â°C ~ 5Â°C)ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.
        notification_id: kimchi_fridge_temp_alert

# ì‹ê¸°ì„¸ì²™ê¸° ì™„ë£Œ ì•Œë¦¼
- id: dishwasher_cycle_complete
  alias: "ì‹ê¸°ì„¸ì²™ê¸° ì™„ë£Œ ì•Œë¦¼"
  description: "ì‹ê¸°ì„¸ì²™ê¸° ì„¸ì²™ì´ ì™„ë£Œë˜ì—ˆì„ ë•Œ ì•Œë¦¼"
  trigger:
    - platform: state
      entity_id: sensor.jubang_siggiseceoggi_remaining_time
      to: "0"
  condition:
    - condition: state
      entity_id: binary_sensor.someone_home
      state: "on"
  action:
    - service: persistent_notification.create
      data:
        title: "ğŸ½ï¸ ì‹ê¸°ì„¸ì²™ê¸° ì™„ë£Œ"
        message: >
          ì‹ê¸°ì„¸ì²™ê¸° ì„¸ì²™ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! 
          ì‹ê¸°ë¥¼ êº¼ë‚´ì£¼ì„¸ìš”. ì´ ì„¸ì²™ ì‹œê°„: {{ states('sensor.jubang_siggiseceoggi_total_time') }}
        notification_id: dishwasher_complete

# ë¦°ìŠ¤ ë³´ì¶© ì•Œë¦¼
- id: rinse_aid_refill_reminder
  alias: "ë¦°ìŠ¤ ë³´ì¶© ì•Œë¦¼"
  description: "ì‹ê¸°ì„¸ì²™ê¸° ë¦°ìŠ¤ ë³´ì¶©ì´ í•„ìš”í•  ë•Œ ì•Œë¦¼"
  trigger:
    - platform: state
      entity_id: binary_sensor.jubang_siggiseceoggi_rinse_refill_needed
      from: "off"
      to: "on"
  action:
    - service: persistent_notification.create
      data:
        title: "ğŸ§´ ë¦°ìŠ¤ ë³´ì¶© í•„ìš”"
        message: >
          ì‹ê¸°ì„¸ì²™ê¸° ë¦°ìŠ¤ ë³´ì¶©ì´ í•„ìš”í•©ë‹ˆë‹¤. 
          í˜„ì¬ ì”ì—¬ëŸ‰: {{ states('sensor.jubang_siggiseceoggi_rinse_aid_dispenser_level') }}
        notification_id: rinse_aid_reminder