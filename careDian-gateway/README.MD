# CareDian Backend Gateway â€“ README

## ğŸ“Œ ê°œìš”

CareDian í”„ë¡œì íŠ¸ëŠ” **ìŠ¤ë§ˆíŠ¸ í™ˆ IoT í”Œë«í¼**ìœ¼ë¡œ,
ë¼ì¦ˆë² ë¦¬íŒŒì´4 ê¸°ë°˜ Home Assistant + FastAPI Gateway + InfluxDB + MySQL + SSO(Auth/OIDC) ì•„í‚¤í…ì²˜ë¥¼ í†µí•©í•©ë‹ˆë‹¤.

ë³¸ ë ˆí¬ì§€í† ë¦¬ëŠ” **FastAPI ê¸°ë°˜ API Gateway** ë° **ë°±ì—”ë“œ ì„œë¹„ìŠ¤**ì˜ ëª…ì„¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

---

## ğŸ“‚ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```bash
CareDian-backend/
â”œâ”€â”€ careDian-gateway/        # FastAPI Gateway ì½”ë“œ
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ api/             # API ë¼ìš°í„° (auth, ha_proxy ë“±)
â”‚   â”‚   â”œâ”€â”€ core/            # ì„¤ì •(config.py), ë³´ì•ˆ, DB ì—°ê²°
â”‚   â”‚   â”œâ”€â”€ models/          # Pydantic ëª¨ë¸ ë° ORM
â”‚   â”‚   â”œâ”€â”€ main.py          # FastAPI ì—”íŠ¸ë¦¬í¬ì¸íŠ¸
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ gunicorn.conf.py     # Gunicorn ì„œë²„ ì„¤ì •
â”‚   â””â”€â”€ requirements.txt     # Python ì˜ì¡´ì„±
â”œâ”€â”€ InfluxDB.md              # IoT ì„¼ì„œ ëª©ë¡ ë° InfluxDB ì—°ë™ ì •ì˜
â”œâ”€â”€ Home Assistant Sensor Data Capture.pdf
â”œâ”€â”€ TechStack.md             # ê¸°ìˆ  ìŠ¤íƒ ì •ì˜
â”œâ”€â”€ ì‘ì—….md                   # ì§„í–‰ ì¤‘ì¸ ì‘ì—… ê³„íš
â””â”€â”€ README.md                # í˜„ì¬ ë¬¸ì„œ
```

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### 1) ë¡œì»¬ ì‹¤í–‰ (ê°œë°œìš©)

```bash
$ cd careDian-gateway
$ uvicorn app.main:app --reload --host 0.0.0.0 --port 8080
```

### 2) í”„ë¡œë•ì…˜ ì‹¤í–‰ (Gunicorn + Uvicorn workers)

```bash
$ gunicorn -c gunicorn.conf.py app.main:app
```

**gunicorn.conf.py**

```python
bind = "0.0.0.0:8080"
workers = 4
worker_class = "uvicorn.workers.UvicornWorker"
```

---

## ğŸ”‘ ì£¼ìš” ê¸°ëŠ¥

### 1. **API Gateway (FastAPI)**

* Home Assistant í”„ë¡ì‹œ API (`/ha/api`)
* Auth / OIDC ê¸°ë°˜ ë¡œê·¸ì¸ (`/auth/login`, `/auth/callback`)
* Health Check (`/healthz`, `/readyz`)
* IoT ì¥ì¹˜ ì´ë²¤íŠ¸ ì—°ë™ (MQTT â†” FastAPI â†” InfluxDB/MySQL)

### 2. **ë°ì´í„°ë² ì´ìŠ¤**

* **MySQL**

  * ì‚¬ìš©ì ê³„ì • / ì¸ì¦ ì •ë³´ / ìë™í™” YAML ì €ì¥
  * Authentik Webhook â†’ FastAPI â†’ MySQL UPSERT
* **InfluxDB**

  * ëª¨ë“  IoT ì„¼ì„œ ì‹œê³„ì—´ ë°ì´í„° ì €ì¥
  * Grafana ëŒ€ì‹œë³´ë“œ ì—°ë™

  â†’ [InfluxDB.md](InfluxDB.md)ì— ì„¼ì„œ/ì¸¡ì • í•­ëª© ì •ì˜

### 3. **í†µì‹  (MQTT)**

* Mosquitto MQTT Broker
* TLS 1.3 / mTLS ì ìš©
* ëª¨ë“  ë©”ì‹œì§€ëŠ” InfluxDB ë¡œê¹…
* LG ThinQ API ì—°ë™ (Rate Limit ëŒ€ì‘ í¬í•¨)

### 4. **SSO (OIDC ê¸°ë°˜)**

* Authentikì„ IdPë¡œ ì‚¬ìš©
* Google / Naver / Kakao ì†Œì…œ ë¡œê·¸ì¸ ì§€ì›
* Home Assistant â†” Authentik â†” FastAPI ì—°ë™
* Redirect URI ì˜ˆì‹œ:

  ```
  https://auth-caredian.gleeze.com/auth/callback
  https://caredian.gleeze.com/auth/openid/callback
  ```

### 5. **ë³´ì•ˆ**

* OAuth2 / OIDC ê¸°ë°˜ ì¸ì¦
* HS256 JWT ì„œëª…
* Redis ê¸°ë°˜ ì„¸ì…˜ ê²€ì¦ (ì´ˆë‹¹ 10,000 req ì´ìƒ ì²˜ë¦¬)
* API Key ê¸°ë°˜ ë³´í˜¸ ê¸°ëŠ¥ ì¶”ê°€

---

## âš™ï¸ ê¸°ìˆ  ìŠ¤íƒ

* **Backend**: FastAPI, Uvicorn, Gunicorn
* **Database**: MySQL, InfluxDB
* **Auth**: Authentik (OIDC/SAML), JWT, Redis
* **IoT**: Home Assistant, Mosquitto MQTT, LG ThinQ API
* **Visualization**: Grafana
* **Infra**: Raspberry Pi 4, AWS EC2
