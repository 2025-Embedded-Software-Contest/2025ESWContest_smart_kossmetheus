api_version: 1
host: 192.168.1.175
port: 8086
database: !secret influxdb_database
username: !secret influxdb_username
password: !secret influxdb_password
max_retries: 3
default_measurement: state
ssl: false
verify_ssl: false
precision: s

include:
  domains:
    - sensor
    - binary_sensor
    - switch
    - light
    - device_tracker
    - climate
    - weather

  # =======================
  # 방별 영역 그룹화
  # =======================
  entities:
    # === 거실 ===
    - climate.seutaendeuhyeong_eeokeon
    - sensor.seutaendeuhyeong_eeokeon_temperature
    - sensor.seutaendeuhyeong_eeokeon_humidity
    - sensor.seutaendeuhyeong_eeokeon_power
    - sensor.seutaendeuhyeong_eeokeon_energy
    - light.smart_bulb
    - sensor.fast_com_download

    # === 주방 ===
    - sensor.jubang_gimcinaengjanggo_middle_temperature
    - sensor.jubang_siggiseceoggi_total_time
    - switch.kitchen_hood

    # === 우현이방 ===
    - device_tracker.gimuhyeonyi_macbook_pro
    - sensor.gimuhyeonyi_macbook_pro_storage_2
    - binary_sensor.gimuhyeonyi_macbook_pro_camera_in_use
    - light.smart_bulb_2
    - sensor.uhyeonyi_ipad_pro_battery_level

    # === 안방 ===
    - switch.anbang_hwajangsil_hwangi
    - switch.anbang_syaweosil_deung

    # === 화장실/샤워실 ===
    - binary_sensor.jubang_siggiseceoggi_door
    - sensor.jubang_siggiseceoggi_remaining_time

    # === 실험실 ===
    - switch.jodo_senseo_silheomsil
    - switch.sori_senseo_silheomsil

    # === 기타 ===
    - device_tracker.esp32_cam
    - weather.forecast_jib
    - sensor.time
    - sensor.date
    # - fall_events

  # =======================
  # 기능별 그룹화
  # =======================
  entity_globs:
    - sensor.*temperature*
    - sensor.*humidity*
    - sensor.*power*
    - sensor.*energy*
    - sensor.*battery*
    - binary_sensor.*motion*
    - binary_sensor.*presence*
    - device_tracker.*
    - sensor.*_download*
    - sensor.*_upload*

exclude:
  domains:
    - media_player
    - automation
    - script
    - button
    - number
    - select
    - camera
    - update
    - person

  entity_globs:
    - sensor.*firmware*
    - sensor.*status_text*
    - sensor.*last_seen*
    - sensor.*availability
    - binary_sensor.*update_available
    - sensor.*_focus*
    - binary_sensor.*_focus*
    - sensor.*_permission*
    - sensor.*_location*

tags_attributes:
  - friendly_name
  - device_class
  - unit_of_measurement
  - area_id
  - state_class

ignore_attributes:
  - icon
  - attribution
  - entity_picture
  - suggested_display_precision
  - suggested_precision
  - restore_state
  - supported_features
  - source_type
  - context_user_id
  - context_id
  - context_parent_id
  - last_changed
  - last_updated

queries:
  # 1) 낙상 확률 (%). fall_events.measurement 의 predicted_prob(0~1)을 %로 변환
  - name: "Fall Probability"
    measurement: "fall_events"
    where: "time > now() - 10m"
    # 특정 디바이스/위치만 보고 싶으면 아래와 같이 태그 필터 추가
    # where: "time > now() - 10m AND \"device_id\"='esp32_cam' AND \"location\"='거실'"
    field: "predicted_prob"     # 필드명이 다르면 'prob' 등으로 바꾸세요.
    group_function: "last"
    value_template: "{{ (value | float * 100) | round(1) }}"
    unit_of_measurement: "%"

  # 2) 낙상 상태(0/1). 최근 값 그대로 노출
  - name: "Fall State"
    measurement: "fall_events"
    where: "time > now() - 10m"
    field: "fall_state"
    group_function: "last"
    value_template: "{{ value | int }}"

  # 3) 재실/움직임 등(선택)
  - name: "Fall Presence"
    measurement: "fall_events"
    where: "time > now() - 10m"
    field: "presence"
    group_function: "last"
    value_template: "{{ value | int }}"

  - name: "Fall Movement"
    measurement: "fall_events"
    where: "time > now() - 10m"
    field: "movement"
    group_function: "last"
    value_template: "{{ value | int }}"